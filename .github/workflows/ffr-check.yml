name: FFR-check

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      input_file:
        description: 'Optional input file path relative to repo root'
        required: false
        default: ''
      input_dir:
        description: 'Input directory (ENV: INPUT_DIR)'
        required: false
        default: ''
      output_dir:
        description: 'Output directory (ENV: OUTPUT_DIR)'
        required: false
        default: 'output'
      sspec:
        description: 'SSPEC (ENV: SSPEC)'
        required: false
        default: ''
      ube:
        description: 'UBE file path (ENV: UBE)'
        required: false
        default: ''
      mtlolf:
        description: 'MTL_OLF.xml path (ENV: MTLOLF)'
        required: false
        default: ''
      ituff:
        description: 'ITF directory (ENV: ITUFF)'
        required: false
        default: ''
      visualid:
        description: 'VisualID filter (ENV: VISUALID)'
        required: false
        default: ''
      log:
        description: 'Enable console logging (ENV: LOG) true/false'
        required: false
        default: 'false'
      html_stats:
        description: 'Generate HTML stats (ENV: HTML_STATS) true/false'
        required: false
        default: 'true'
      runner:
        description: 'Runner to use (e.g. ubuntu-latest, windows-latest, self-hosted label)'
        required: false
        default: 'ubuntu-latest'

jobs:
  run-gui:
    runs-on: ${{ github.event.inputs.runner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies (Xvfb)
        if: ${{ !contains(github.event.inputs.runner, 'windows') }}
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Validate input paths (Windows)
        if: ${{ contains(github.event.inputs.runner, 'windows') }}
        shell: powershell
        env:
          INPUT_DIR: ${{ github.event.inputs.input_dir }}
          INPUT_FILE: ${{ github.event.inputs.input_file }}
        run: |
          Write-Output "Validating inputs on Windows runner..."
          if ($env:INPUT_DIR -and $env:INPUT_DIR.Trim() -ne '') {
            if (Test-Path $env:INPUT_DIR) {
              Write-Output "Found input_dir at $env:INPUT_DIR"
            } elseif (Test-Path "FFRCheck_Project\$env:INPUT_DIR") {
              Write-Output "Found input_dir at FFRCheck_Project\$env:INPUT_DIR"
            } else {
              Write-Error "ERROR: Input directory not found: $env:INPUT_DIR"
              exit 1
            }
          }

          if ($env:INPUT_FILE -and $env:INPUT_FILE.Trim() -ne '') {
            if (Test-Path $env:INPUT_FILE) {
              Write-Output "Found input_file at $env:INPUT_FILE"
            } elseif (Test-Path "FFRCheck_Project\$env:INPUT_FILE") {
              Write-Output "Found input_file at FFRCheck_Project\$env:INPUT_FILE"
            } else {
              Write-Error "ERROR: Input file not found: $env:INPUT_FILE"
              exit 1
            }
          }

      - name: Validate input paths (Linux/macOS/hosted)
        if: ${{ !contains(github.event.inputs.runner, 'windows') }}
        env:
          INPUT_DIR: ${{ github.event.inputs.input_dir }}
          INPUT_FILE: ${{ github.event.inputs.input_file }}
        run: |
          echo "Validating inputs on hosted runner..."
          if [ -n "${INPUT_DIR}" ]; then
            if [[ "${INPUT_DIR}" =~ ^[A-Za-z]:\\ ]] || [[ "${INPUT_DIR}" =~ ^[A-Za-z]:/ ]] || [[ "${INPUT_DIR}" =~ ^\\\\ ]]; then
              echo "ERROR: INPUT_DIR appears to be a Windows local path: ${INPUT_DIR}"
              echo "Hosted runners cannot access local drives on your machine."
              echo "Please either:"
              echo " - Run this workflow on a Windows runner or a self-hosted runner that has access to the path (set the 'runner' input)."
              echo " - Put input files inside the repository or at an accessible URL and provide a repo-relative path or URL."
              exit 1
            fi

            if [ -d "${INPUT_DIR}" ]; then
              echo "Found input_dir at ${INPUT_DIR}"
            elif [ -d "FFRCheck_Project/${INPUT_DIR}" ]; then
              echo "Found input_dir at FFRCheck_Project/${INPUT_DIR}"
            else
              echo "ERROR: Input directory not found: ${INPUT_DIR}"; exit 1
            fi
          fi

          if [ -n "${INPUT_FILE}" ]; then
            if [[ "${INPUT_FILE}" =~ ^[A-Za-z]:\\ ]] || [[ "${INPUT_FILE}" =~ ^[A-Za-z]:/ ]] || [[ "${INPUT_FILE}" =~ ^\\\\ ]]; then
              echo "ERROR: INPUT_FILE appears to be a Windows local path: ${INPUT_FILE}"
              echo "Hosted runners cannot access local drives on your machine. Use a Windows or self-hosted runner or provide a repo-relative path.";
              exit 1
            fi

            if [ -f "${INPUT_FILE}" ]; then
              echo "Found input_file at ${INPUT_FILE}"
            elif [ -f "FFRCheck_Project/${INPUT_FILE}" ]; then
              echo "Found input_file at FFRCheck_Project/${INPUT_FILE}"
            else
              echo "ERROR: Input file not found: ${INPUT_FILE}"; exit 1
            fi
          fi
      

      - name: Run gui_app.py (Linux/macOS/hosted)
        if: ${{ !contains(github.event.inputs.runner, 'windows') }}
        working-directory: FFRCheck_Project
        env:
          INPUT_FILE: ${{ github.event.inputs.input_file }}
          INPUT_DIR: ${{ github.event.inputs.input_dir }}
          OUTPUT_DIR: ${{ github.event.inputs.output_dir }}
          SSPEC: ${{ github.event.inputs.sspec }}
          UBE: ${{ github.event.inputs.ube }}
          MTLOLF: ${{ github.event.inputs.mtlolf }}
          ITUFF: ${{ github.event.inputs.ituff }}
          VISUALID: ${{ github.event.inputs.visualid }}
          LOG: ${{ github.event.inputs.log }}
          HTML_STATS: ${{ github.event.inputs.html_stats }}
        run: |
          # Try to detect a geometry string in gui_app.py (e.g. geometry("800x600"))
          DEFAULT_SCREEN_SIZE="1280x1024x24"
          # Use grep -P to extract WIDTHxHEIGHT from either possible file locations
          geom=$( (grep -Po "geometry\(\s*[\"'\"]\K\d+x\d+(?=[\"'\"])" gui_app.py 2>/dev/null || true) | head -n1 )
          if [ -z "$geom" ]; then
            geom=$( (grep -Po "geometry\(\s*[\"'\"]\K\d+x\d+(?=[\"'\"])" FFRCheck_Project/gui_app.py 2>/dev/null || true) | head -n1 )
          fi
          if [ -n "$geom" ]; then
            SCREEN_SIZE="${geom}x24"
          else
            SCREEN_SIZE="$DEFAULT_SCREEN_SIZE"
          fi
          echo "Using Xvfb screen size: ${SCREEN_SIZE}"
          if [ -n "${INPUT_FILE}" ]; then
            xvfb-run -a -s "-screen 0 ${SCREEN_SIZE}" python gui_app.py "${INPUT_FILE}"
          else
            xvfb-run -a -s "-screen 0 ${SCREEN_SIZE}" python gui_app.py
          fi

      - name: Run gui_app.py (Windows)
        if: ${{ contains(github.event.inputs.runner, 'windows') }}
        shell: powershell
        working-directory: FFRCheck_Project
        env:
          INPUT_FILE: ${{ github.event.inputs.input_file }}
          INPUT_DIR: ${{ github.event.inputs.input_dir }}
          OUTPUT_DIR: ${{ github.event.inputs.output_dir }}
          SSPEC: ${{ github.event.inputs.sspec }}
          UBE: ${{ github.event.inputs.ube }}
          MTLOLF: ${{ github.event.inputs.mtlolf }}
          ITUFF: ${{ github.event.inputs.ituff }}
          VISUALID: ${{ github.event.inputs.visualid }}
          LOG: ${{ github.event.inputs.log }}
          HTML_STATS: ${{ github.event.inputs.html_stats }}
        run: |
          Write-Output "Running gui_app.py on Windows runner..."
          if ($env:INPUT_FILE -and $env:INPUT_FILE.Trim() -ne '') {
            python gui_app.py $env:INPUT_FILE
          } else {
            python gui_app.py
          }

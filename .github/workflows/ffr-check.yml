name: FFR-check

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      input_file:
        description: 'Optional input file path relative to repo root'
        required: false
        default: ''
      input_dir:
        description: 'Input directory (ENV: INPUT_DIR)'
        required: false
        default: ''
      output_dir:
        description: 'Output directory (ENV: OUTPUT_DIR)'
        required: false
        default: 'output'
      sspec:
        description: 'SSPEC (ENV: SSPEC)'
        required: false
        default: ''
      ube:
        description: 'UBE file path (ENV: UBE)'
        required: false
        default: ''
      mtlolf:
        description: 'MTL_OLF.xml path (ENV: MTLOLF)'
        required: false
        default: ''
      ituff:
        description: 'ITF directory (ENV: ITUFF)'
        required: false
        default: ''
      visualid:
        description: 'VisualID filter (ENV: VISUALID)'
        required: false
        default: ''
      log:
        description: 'Enable console logging (ENV: LOG) true/false'
        required: false
        default: 'false'
      html_stats:
        description: 'Generate HTML stats (ENV: HTML_STATS) true/false'
        required: false
        default: 'true'
      runner:
        description: 'Runner label (ignored; workflow now Windows-only)'
        required: false
        default: 'windows-latest'

jobs:
  run-gui:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          if (Test-Path 'requirements.txt') {
            python -m pip install -r requirements.txt
          }
      - name: Validate input paths (Windows)
        shell: powershell
        env:
          INPUT_DIR: ${{ github.event.inputs.input_dir }}
          INPUT_FILE: ${{ github.event.inputs.input_file }}
        run: |
          Write-Output "Validating Windows input paths..."
          if ($env:INPUT_DIR -and $env:INPUT_DIR.Trim() -ne '') {
            if (Test-Path $env:INPUT_DIR) {
              Write-Output "Found input_dir at $env:INPUT_DIR"
            } elseif (Test-Path "FFRCheck_Project\$env:INPUT_DIR") {
              Write-Output "Found input_dir at FFRCheck_Project\$env:INPUT_DIR"
            } else {
              Write-Error "ERROR: Input directory not found: $env:INPUT_DIR"
              exit 1
            }
          }

          if ($env:INPUT_FILE -and $env:INPUT_FILE.Trim() -ne '') {
            if (Test-Path $env:INPUT_FILE) {
              Write-Output "Found input_file at $env:INPUT_FILE"
            } elseif (Test-Path "FFRCheck_Project\$env:INPUT_FILE") {
              Write-Output "Found input_file at FFRCheck_Project\$env:INPUT_FILE"
            } else {
              Write-Error "ERROR: Input file not found: $env:INPUT_FILE"
              exit 1
            }
          }
      

      - name: Run gui_app.py (Windows)
        shell: powershell
        working-directory: FFRCheck_Project
        env:
          INPUT_FILE: ${{ github.event.inputs.input_file }}
          INPUT_DIR: ${{ github.event.inputs.input_dir }}
          OUTPUT_DIR: ${{ github.event.inputs.output_dir }}
          SSPEC: ${{ github.event.inputs.sspec }}
          UBE: ${{ github.event.inputs.ube }}
          MTLOLF: ${{ github.event.inputs.mtlolf }}
          ITUFF: ${{ github.event.inputs.ituff }}
          VISUALID: ${{ github.event.inputs.visualid }}
          LOG: ${{ github.event.inputs.log }}
          HTML_STATS: ${{ github.event.inputs.html_stats }}
        run: |
          Write-Output "Running gui_app.py on Windows runner..."
          if ($env:INPUT_FILE -and $env:INPUT_FILE.Trim() -ne '') {
            python gui_app.py $env:INPUT_FILE
          } else {
            python gui_app.py
          }
